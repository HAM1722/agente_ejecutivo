# -*- coding: utf-8 -*-
"""
generador_docx_analisis.py â€” Genera archivos DOCX y anÃ¡lisis LLM de facturas EMCALI
VersiÃ³n mejorada con story, reconciliaciÃ³n y metadatos completos
"""

import csv
import json
import os
from pathlib import Path
from typing import Dict, List, Any, Optional
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI

# Forzar carga del .env desde la raÃ­z del proyecto
ENV_PATH = Path(__file__).resolve().parent.parent / ".env"
load_dotenv(dotenv_path=ENV_PATH, override=True)

API_KEY = os.getenv("OPENAI_API_KEY")
if not API_KEY:
    raise SystemExit("âŒ No se encontrÃ³ OPENAI_API_KEY en .env")

client = OpenAI(api_key=API_KEY)

# Prompt para anÃ¡lisis de factura EMCALI
PROMPT_ANALISIS_EMCALI = """Eres un analista experto en facturas de servicios pÃºblicos EMCALI.
Analiza la informaciÃ³n extraÃ­da de la factura y genera un informe detallado y preciso.

INFORMACIÃ“N DE LA FACTURA:
{datos_factura}

IMPORTANTE: Usa EXACTAMENTE los valores numÃ©ricos proporcionados. No inventes ni redondees valores.
Si un valor es "7,111.00", Ãºsalo exactamente asÃ­. Si es "8,004,574.00", Ãºsalo exactamente asÃ­.

TAREA: Genera un anÃ¡lisis completo y preciso que incluya:

## 1. **RESUMEN EJECUTIVO**
- **Cliente**: [nombre exacto del cliente]
- **DirecciÃ³n**: [direcciÃ³n exacta]
- **PerÃ­odo**: [fecha desde] a [fecha hasta] ([dÃ­as] dÃ­as)
- **Total a pagar**: [valor exacto] [moneda]
- **Consumo de energÃ­a**: [consumo exacto] kWh

## 2. **ANÃLISIS DE CONSUMO ELÃ‰CTRICO**
- **Lectura anterior**: [valor exacto] kWh
- **Lectura actual**: [valor exacto] kWh  
- **Diferencia**: [diferencia exacta] kWh
- **Consumo del perÃ­odo**: [consumo exacto] kWh
- **Consumo diario promedio**: [cÃ¡lculo preciso] kWh/dÃ­a

## 3. **DESGLOSE DETALLADO DE COSTOS**
- **EnergÃ­a elÃ©ctrica**: [valor exacto] [moneda]
- **Aseo**: [valor exacto] [moneda]
- **Alumbrado pÃºblico**: [valor exacto] [moneda]
- **Tasa de seguridad**: [valor exacto] [moneda]
- **Subtotal EMCALI**: [valor exacto] [moneda]
- **IVA**: [valor exacto] [moneda]
- **Total a pagar**: [valor exacto] [moneda]

## 4. **ANÃLISIS TARIFARIO**
- **Valor unitario de energÃ­a**: [valor exacto] [moneda]/kWh
- **Costo por kWh consumido**: [cÃ¡lculo preciso]
- **Porcentaje de servicios adicionales**: [cÃ¡lculo preciso]%

## 5. **OBSERVACIONES TÃ‰CNICAS**
- AnÃ¡lisis del nivel de tensiÃ³n ([valor])
- Tipo de medidor: [cÃ³digo del medidor]
- Operador de red: [nombre exacto]
- Ciclo de facturaciÃ³n: [nÃºmero]

## 6. **RECOMENDACIONES**
- Eficiencia energÃ©tica
- OptimizaciÃ³n de costos
- Monitoreo de consumo

FORMATO: Usa formato markdown estructurado. Incluye tablas cuando sea apropiado.
Usa EXACTAMENTE los valores proporcionados sin modificar nÃºmeros."""

# Prompt para anÃ¡lisis tÃ©cnico de ingeniero elÃ©ctrico
PROMPT_ANALISIS_TECNICO_ELECTRICO = """Eres un INGENIERO ELÃ‰CTRICO EXPERTO EN ENERGÃA con mÃ¡s de 15 aÃ±os de experiencia en anÃ¡lisis de sistemas elÃ©ctricos, eficiencia energÃ©tica y facturaciÃ³n de servicios pÃºblicos.

Tu cliente te ha proporcionado los datos de su factura EMCALI y necesita un INFORME TÃ‰CNICO PROFESIONAL que explique:

INFORMACIÃ“N DE LA FACTURA:
{datos_factura}

TAREA: Genera un INFORME TÃ‰CNICO COMPLETO como ingeniero elÃ©ctrico que incluya:

## 1. **ANÃLISIS TÃ‰CNICO DEL CONSUMO ELÃ‰CTRICO**

### 1.1 CaracterizaciÃ³n del Consumo
- **Potencia Promedio Consumida**: Calcular en kW basado en el consumo diario
- **Factor de Carga**: AnÃ¡lisis de la distribuciÃ³n del consumo en el perÃ­odo
- **Perfil de Consumo**: Identificar si es residencial, comercial o industrial
- **Eficiencia del Sistema**: Evaluar si el consumo es normal para el tipo de instalaciÃ³n

### 1.2 AnÃ¡lisis de Lecturas
- **Diferencia de Lecturas**: Explicar tÃ©cnicamente por quÃ© se consume esa cantidad
- **PrecisiÃ³n del Medidor**: Evaluar si las lecturas son coherentes
- **Posibles PÃ©rdidas**: Identificar si hay fugas o consumos anÃ³malos

## 2. **ANÃLISIS DE TARIFAS Y COSTOS TÃ‰CNICOS**

### 2.1 Estructura Tarifaria
- **Tarifa Base**: Explicar por quÃ© se aplica esa tarifa unitaria
- **Componentes de la Tarifa**: Desglose tÃ©cnico de cada componente
- **ComparaciÃ³n con EstÃ¡ndares**: Evaluar si la tarifa es competitiva

### 2.2 AnÃ¡lisis de Cargos Adicionales
- **Alumbrado PÃºblico**: JustificaciÃ³n tÃ©cnica del cargo
- **Tasa de Seguridad**: Explicar el componente tÃ©cnico
- **Otros Servicios**: AnÃ¡lisis de cada cargo adicional

## 3. **DIAGNÃ“STICO TÃ‰CNICO DEL SISTEMA**

### 3.1 EvaluaciÃ³n de la InstalaciÃ³n
- **Nivel de TensiÃ³n**: AnÃ¡lisis del nivel de tensiÃ³n (1 = Baja tensiÃ³n)
- **Tipo de Medidor**: Evaluar si el medidor es apropiado
- **Operador de Red**: Verificar la configuraciÃ³n tÃ©cnica

### 3.2 IdentificaciÃ³n de Problemas
- **Consumo AnÃ³malo**: Detectar si hay patrones inusuales
- **Ineficiencias**: Identificar posibles mejoras tÃ©cnicas
- **Riesgos TÃ©cnicos**: Evaluar la seguridad de la instalaciÃ³n

## 4. **RECOMENDACIONES TÃ‰CNICAS**

### 4.1 OptimizaciÃ³n EnergÃ©tica
- **Medidas de Ahorro**: Recomendaciones tÃ©cnicas especÃ­ficas
- **Mejoras de Eficiencia**: Sugerencias de equipos o sistemas
- **Cambios de HÃ¡bitos**: Consejos tÃ©cnicos para el usuario

### 4.2 Mantenimiento Preventivo
- **RevisiÃ³n de InstalaciÃ³n**: QuÃ© verificar tÃ©cnicamente
- **CalibraciÃ³n de Medidor**: CuÃ¡ndo es necesaria
- **Actualizaciones**: Mejoras tÃ©cnicas recomendadas

## 5. **CONCLUSIONES TÃ‰CNICAS**

### 5.1 Resumen Ejecutivo TÃ©cnico
- **Estado de la InstalaciÃ³n**: EvaluaciÃ³n tÃ©cnica general
- **Eficiencia del Sistema**: CalificaciÃ³n tÃ©cnica del consumo
- **Recomendaciones Prioritarias**: Acciones tÃ©cnicas mÃ¡s importantes

### 5.2 PrÃ³ximos Pasos TÃ©cnicos
- **Monitoreo**: QuÃ© parÃ¡metros tÃ©cnicos vigilar
- **Mejoras**: Plan de acciÃ³n tÃ©cnico
- **Seguimiento**: CuÃ¡ndo realizar la prÃ³xima evaluaciÃ³n

## FORMATO DEL INFORME:
- Usa lenguaje tÃ©cnico apropiado pero comprensible
- Incluye cÃ¡lculos tÃ©cnicos cuando sea relevante
- Proporciona explicaciones tÃ©cnicas detalladas
- Usa unidades tÃ©cnicas correctas (kW, kWh, factor de potencia, etc.)
- Incluye tablas con datos tÃ©cnicos cuando sea apropiado
- MantÃ©n un tono profesional de ingeniero experto

IMPORTANTE: Explica cada valor tÃ©cnicamente, no solo quÃ© es, sino POR QUÃ‰ tiene ese valor y quÃ© significa para el cliente."""


def leer_csv_emcali(ruta_csv: str = "outputs/facturas_emcali.csv") -> List[Dict[str, Any]]:
    """
    Lee el archivo CSV con datos extraÃ­dos de facturas EMCALI.
    
    Args:
        ruta_csv: Ruta al archivo CSV
        
    Returns:
        Lista de diccionarios con los datos de cada factura
    """
    if not Path(ruta_csv).exists():
        raise FileNotFoundError(f"No se encontrÃ³ el archivo CSV: {ruta_csv}")
    
    facturas = []
    with open(ruta_csv, 'r', encoding='utf-8') as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            # Limpiar y convertir datos
            factura_limpia = {}
            for key, value in row.items():
                if value == "":
                    factura_limpia[key] = None
                elif key in ['dias_facturados']:
                    try:
                        factura_limpia[key] = int(value) if value else None
                    except:
                        factura_limpia[key] = None
                elif key in ['energia_kwh', 'energia_unitario_cop_kwh', 'energia_valor_total', 
                           'energia_total_bloque', 'aseo_total', 'alumbrado_publico_total', 
                           'tasa_seguridad_total', 'subtotal_emcali', 'iva', 'total_operacion_mes', 
                           'total_a_pagar', 'lectura_anterior', 'lectura_actual', 'diferencia_kwh', 
                           'consumo_kwh']:
                    try:
                        # Limpiar formato de nÃºmeros (remover comas y convertir a float)
                        valor_limpio = str(value).replace(',', '').replace('"', '')
                        factura_limpia[key] = float(valor_limpio) if valor_limpio else None
                    except:
                        factura_limpia[key] = None
                else:
                    factura_limpia[key] = value.strip() if value else None
            
            facturas.append(factura_limpia)
    
    return facturas


def generar_docx_factura(datos_factura: Dict[str, Any], ruta_salida: str = None) -> str:
    """
    Genera un archivo DOCX con la informaciÃ³n de la factura.
    
    Args:
        datos_factura: Datos de la factura
        ruta_salida: Ruta donde guardar el DOCX
        
    Returns:
        Ruta del archivo DOCX generado
    """
    try:
        from docx import Document
        from docx.shared import Inches, Pt
        from docx.enum.text import WD_ALIGN_PARAGRAPH
        from docx.oxml.shared import OxmlElement, qn
    except ImportError:
        print("âŒ Error: Se requiere python-docx. Instala con: pip install python-docx")
        return None
    
    # Crear documento
    doc = Document()
    
    # Configurar ruta de salida
    if not ruta_salida:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        cliente_nombre = datos_factura.get('cliente_nombre', 'Cliente').replace(' ', '_')
        ruta_salida = f"outputs/informe_factura_{cliente_nombre}_{timestamp}.docx"
    
    # Crear directorio si no existe
    Path(ruta_salida).parent.mkdir(parents=True, exist_ok=True)
    
    # TÃ­tulo principal
    title = doc.add_heading('INFORME DE FACTURA EMCALI', 0)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # InformaciÃ³n del cliente
    doc.add_heading('INFORMACIÃ“N DEL CLIENTE', level=1)
    
    info_cliente = [
        ('Nombre del Cliente', datos_factura.get('cliente_nombre', 'No disponible')),
        ('NÃºmero de Contrato', datos_factura.get('contrato', 'No disponible')),
        ('NIU', datos_factura.get('niu', 'No disponible')),
        ('DirecciÃ³n de InstalaciÃ³n', datos_factura.get('direccion_instalacion', 'No disponible')),
        ('Operador de Red', datos_factura.get('operador_red', 'No disponible')),
        ('Nivel de TensiÃ³n', datos_factura.get('nivel_tension', 'No disponible')),
        ('Medidor', datos_factura.get('medidor', 'No disponible')),
        ('Ciclo', datos_factura.get('ciclo', 'No disponible'))
    ]
    
    for etiqueta, valor in info_cliente:
        if valor and valor != 'No disponible':
            p = doc.add_paragraph()
            p.add_run(f'{etiqueta}: ').bold = True
            p.add_run(str(valor))
    
    # PerÃ­odo de facturaciÃ³n
    doc.add_heading('PERÃODO DE FACTURACIÃ“N', level=1)
    
    periodo_info = [
        ('Fecha Desde', datos_factura.get('periodo_desde', 'No disponible')),
        ('Fecha Hasta', datos_factura.get('periodo_hasta', 'No disponible')),
        ('DÃ­as Facturados', datos_factura.get('dias_facturados', 'No disponible')),
        ('Fecha de ExpediciÃ³n', datos_factura.get('fecha_expedicion', 'No disponible')),
        ('Fecha de Vencimiento', datos_factura.get('fecha_vencimiento', 'No disponible'))
    ]
    
    for etiqueta, valor in periodo_info:
        if valor and valor != 'No disponible':
            p = doc.add_paragraph()
            p.add_run(f'{etiqueta}: ').bold = True
            p.add_run(str(valor))
    
    # Lecturas y consumo
    doc.add_heading('LECTURAS Y CONSUMO', level=1)
    
    lecturas_info = [
        ('Lectura Anterior', datos_factura.get('lectura_anterior', 'No disponible')),
        ('Lectura Actual', datos_factura.get('lectura_actual', 'No disponible')),
        ('Diferencia kWh', datos_factura.get('diferencia_kwh', 'No disponible')),
        ('Consumo kWh', datos_factura.get('consumo_kwh', 'No disponible'))
    ]
    
    for etiqueta, valor in lecturas_info:
        if valor and valor != 'No disponible':
            p = doc.add_paragraph()
            p.add_run(f'{etiqueta}: ').bold = True
            p.add_run(str(valor))
    
    # Bloque ENERGÃA
    doc.add_heading('BLOQUE ENERGÃA', level=1)
    
    energia_info = [
        ('EnergÃ­a kWh', datos_factura.get('energia_kwh', 'No disponible')),
        ('Valor Unitario COP/kWh', datos_factura.get('energia_unitario_cop_kwh', 'No disponible')),
        ('Valor Total EnergÃ­a', datos_factura.get('energia_valor_total', 'No disponible')),
        ('Total Bloque EnergÃ­a', datos_factura.get('energia_total_bloque', 'No disponible'))
    ]
    
    for etiqueta, valor in energia_info:
        if valor and valor != 'No disponible':
            p = doc.add_paragraph()
            p.add_run(f'{etiqueta}: ').bold = True
            if isinstance(valor, (int, float)):
                p.add_run(f"${valor:,.2f} COP" if 'COP' in etiqueta else f"{valor:,.2f}")
            else:
                p.add_run(str(valor))
    
    # Otros servicios
    doc.add_heading('OTROS SERVICIOS', level=1)
    
    otros_servicios = [
        ('Aseo', datos_factura.get('aseo_total', 'No disponible')),
        ('Alumbrado PÃºblico', datos_factura.get('alumbrado_publico_total', 'No disponible')),
        ('Tasa Seguridad', datos_factura.get('tasa_seguridad_total', 'No disponible'))
    ]
    
    for etiqueta, valor in otros_servicios:
        if valor and valor != 'No disponible':
            p = doc.add_paragraph()
            p.add_run(f'{etiqueta}: ').bold = True
            if isinstance(valor, (int, float)):
                p.add_run(f"${valor:,.2f} COP")
            else:
                p.add_run(str(valor))
    
    # Totales
    doc.add_heading('TOTALES', level=1)
    
    totales_info = [
        ('Subtotal EMCALI', datos_factura.get('subtotal_emcali', 'No disponible')),
        ('IVA', datos_factura.get('iva', 'No disponible')),
        ('Total OperaciÃ³n Mes', datos_factura.get('total_operacion_mes', 'No disponible')),
        ('Total a Pagar', datos_factura.get('total_a_pagar', 'No disponible')),
        ('Moneda', datos_factura.get('moneda', 'No disponible'))
    ]
    
    for etiqueta, valor in totales_info:
        if valor and valor != 'No disponible':
            p = doc.add_paragraph()
            p.add_run(f'{etiqueta}: ').bold = True
            if isinstance(valor, (int, float)) and 'Moneda' not in etiqueta:
                p.add_run(f"${valor:,.2f} COP")
            else:
                p.add_run(str(valor))
    
    # Guardar documento
    doc.save(ruta_salida)
    print(f"âœ… Documento DOCX generado: {ruta_salida}")
    
    return ruta_salida


def analizar_factura_llm(datos_factura: Dict[str, Any]) -> Dict[str, Any]:
    """
    Analiza la factura usando LLM para generar insights y recomendaciones.
    
    Args:
        datos_factura: Datos de la factura
        
    Returns:
        Diccionario con el anÃ¡lisis del LLM
    """
    try:
        # Formatear datos para el prompt
        datos_formateados = []
        for key, value in datos_factura.items():
            if value is not None and value != "":
                if isinstance(value, (int, float)):
                    if 'total' in key.lower() or 'valor' in key.lower() or 'costo' in key.lower():
                        datos_formateados.append(f"{key}: ${value:,.2f} COP")
                    else:
                        datos_formateados.append(f"{key}: {value:,.2f}")
                else:
                    datos_formateados.append(f"{key}: {value}")
        
        datos_texto = "\n".join(datos_formateados)
        
        # Llamar a OpenAI
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "user", "content": PROMPT_ANALISIS_EMCALI.format(datos_factura=datos_texto)}
            ],
            temperature=0.3,
            max_tokens=3000
        )
        
        # Extraer respuesta
        analisis = response.choices[0].message.content.strip()
        
        # Guardar para debug
        guardar_debug_analisis(datos_factura, analisis)
        
        return {
            "exito": True,
            "analisis": analisis,
            "timestamp": datetime.now().isoformat()
        }
        
    except Exception as e:
        return {
            "exito": False,
            "error": f"Error en anÃ¡lisis LLM: {str(e)}",
            "timestamp": datetime.now().isoformat()
        }


def guardar_debug_analisis(datos_factura: Dict[str, Any], analisis: str):
    """
    Guarda informaciÃ³n de debug para el anÃ¡lisis.
    
    Args:
        datos_factura: Datos de la factura
        analisis: AnÃ¡lisis generado por el LLM
    """
    debug_dir = Path("outputs") / "debug"
    debug_dir.mkdir(parents=True, exist_ok=True)
    
    # Guardar anÃ¡lisis
    with open(debug_dir / "analisis_llm.txt", "w", encoding="utf-8") as f:
        f.write("=== ANÃLISIS LLM DE FACTURA EMCALI ===\n\n")
        f.write(f"Fecha: {datetime.now()}\n")
        f.write(f"Cliente: {datos_factura.get('cliente_nombre', 'N/A')}\n")
        f.write(f"Contrato: {datos_factura.get('contrato', 'N/A')}\n")
        f.write("="*50 + "\n\n")
        f.write(analisis)
    
    # Guardar datos en JSON
    with open(debug_dir / "datos_para_analisis.json", "w", encoding="utf-8") as f:
        json.dump({
            "datos_factura": datos_factura,
            "timestamp": datetime.now().isoformat()
        }, f, ensure_ascii=False, indent=2)


def procesar_factura_completa(ruta_csv: str = "outputs/facturas_emcali.csv", 
                            generar_docx: bool = True, 
                            hacer_analisis: bool = True) -> Dict[str, Any]:
    """
    Procesa completamente una factura: lee CSV, genera DOCX y hace anÃ¡lisis LLM.
    
    Args:
        ruta_csv: Ruta al archivo CSV
        generar_docx: Si generar archivo DOCX
        hacer_analisis: Si hacer anÃ¡lisis con LLM
        
    Returns:
        Diccionario con resultados del procesamiento
    """
    try:
        print("ğŸ” Procesando factura completa...")
        
        # Leer datos del CSV
        print("ğŸ“„ Leyendo datos del CSV...")
        facturas = leer_csv_emcali(ruta_csv)
        
        if not facturas:
            return {"error": "No se encontraron datos en el CSV"}
        
        factura = facturas[0]  # Tomar la primera factura
        resultados = {
            "exito": True,
            "factura_procesada": factura.get('cliente_nombre', 'N/A'),
            "archivos_generados": []
        }
        
        # Generar DOCX
        if generar_docx:
            print("ğŸ“ Generando archivo DOCX...")
            ruta_docx = generar_docx_factura(factura)
            if ruta_docx:
                resultados["archivos_generados"].append(ruta_docx)
        
        # Hacer anÃ¡lisis LLM
        if hacer_analisis:
            print("ğŸ¤– Generando anÃ¡lisis con LLM...")
            analisis_resultado = analizar_factura_llm(factura)
            resultados["analisis_llm"] = analisis_resultado
            
            if analisis_resultado["exito"]:
                # Guardar anÃ¡lisis en archivo separado
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                cliente_nombre = factura.get('cliente_nombre', 'Cliente').replace(' ', '_')
                ruta_analisis = f"outputs/analisis_factura_{cliente_nombre}_{timestamp}.txt"
                
                with open(ruta_analisis, "w", encoding="utf-8") as f:
                    f.write("ANÃLISIS DE FACTURA EMCALI\n")
                    f.write("="*50 + "\n\n")
                    f.write(analisis_resultado["analisis"])
                
                resultados["archivos_generados"].append(ruta_analisis)
                print(f"âœ… AnÃ¡lisis guardado: {ruta_analisis}")
        
        print("âœ… Procesamiento completo finalizado")
        return resultados
        
    except Exception as e:
        return {"error": f"Error en procesamiento completo: {str(e)}"}


def agregar_analisis_a_docx(ruta_docx: str, analisis: str) -> str:
    """
    Agrega el anÃ¡lisis LLM a un documento DOCX existente.
    
    Args:
        ruta_docx: Ruta al archivo DOCX
        analisis: AnÃ¡lisis generado por el LLM
        
    Returns:
        Ruta del archivo DOCX actualizado
    """
    try:
        from docx import Document
        from docx.shared import Inches
        from docx.enum.text import WD_ALIGN_PARAGRAPH
        
        # Abrir documento existente
        doc = Document(ruta_docx)
        
        # Agregar pÃ¡gina nueva
        doc.add_page_break()
        
        # TÃ­tulo del anÃ¡lisis
        title = doc.add_heading('ANÃLISIS INTELIGENTE DE LA FACTURA', 0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Agregar anÃ¡lisis
        doc.add_paragraph(analisis)
        
        # Guardar documento actualizado
        ruta_actualizada = ruta_docx.replace('.docx', '_con_analisis.docx')
        doc.save(ruta_actualizada)
        
        print(f"âœ… AnÃ¡lisis agregado al DOCX: {ruta_actualizada}")
        return ruta_actualizada
        
    except Exception as e:
        print(f"âŒ Error agregando anÃ¡lisis al DOCX: {e}")
        return ruta_docx


def analizar_factura_tecnico_electrico(datos_factura: Dict[str, Any]) -> Dict[str, Any]:
    """
    Analiza la factura como ingeniero elÃ©ctrico experto usando OpenAI.
    
    Args:
        datos_factura: Datos de la factura
        
    Returns:
        Diccionario con el anÃ¡lisis tÃ©cnico del LLM
    """
    try:
        # Formatear datos para el prompt tÃ©cnico
        datos_formateados = []
        for key, value in datos_factura.items():
            if value is not None and value != "":
                if isinstance(value, (int, float)):
                    if 'total' in key.lower() or 'valor' in key.lower() or 'costo' in key.lower():
                        datos_formateados.append(f"{key}: ${value:,.2f} COP")
                    else:
                        datos_formateados.append(f"{key}: {value:,.2f}")
                else:
                    datos_formateados.append(f"{key}: {value}")
        
        datos_texto = "\n".join(datos_formateados)
        
        # Llamar a OpenAI con el prompt tÃ©cnico
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "user", "content": PROMPT_ANALISIS_TECNICO_ELECTRICO.format(datos_factura=datos_texto)}
            ],
            temperature=0.2,  # MÃ¡s bajo para anÃ¡lisis tÃ©cnico mÃ¡s preciso
            max_tokens=4000   # MÃ¡s tokens para anÃ¡lisis tÃ©cnico detallado
        )
        
        # Extraer respuesta
        analisis_tecnico = response.choices[0].message.content.strip()
        
        # Guardar para debug
        guardar_debug_analisis_tecnico(datos_factura, analisis_tecnico)
        
        return {
            "exito": True,
            "analisis_tecnico": analisis_tecnico,
            "timestamp": datetime.now().isoformat(),
            "tipo": "analisis_tecnico_electrico"
        }
        
    except Exception as e:
        return {
            "exito": False,
            "error": f"Error en anÃ¡lisis tÃ©cnico elÃ©ctrico: {str(e)}",
            "timestamp": datetime.now().isoformat()
        }


def guardar_debug_analisis_tecnico(datos_factura: Dict[str, Any], analisis_tecnico: str):
    """
    Guarda informaciÃ³n de debug para el anÃ¡lisis tÃ©cnico.
    
    Args:
        datos_factura: Datos de la factura
        analisis_tecnico: AnÃ¡lisis tÃ©cnico generado por el LLM
    """
    debug_dir = Path("outputs") / "debug"
    debug_dir.mkdir(parents=True, exist_ok=True)
    
    # Guardar anÃ¡lisis tÃ©cnico
    with open(debug_dir / "analisis_tecnico_electrico.txt", "w", encoding="utf-8") as f:
        f.write("=== ANÃLISIS TÃ‰CNICO ELÃ‰CTRICO DE FACTURA EMCALI ===\n\n")
        f.write(f"Fecha: {datetime.now()}\n")
        f.write(f"Cliente: {datos_factura.get('cliente_nombre', 'N/A')}\n")
        f.write(f"Contrato: {datos_factura.get('contrato', 'N/A')}\n")
        f.write(f"Tipo: AnÃ¡lisis TÃ©cnico de Ingeniero ElÃ©ctrico\n")
        f.write("="*60 + "\n\n")
        f.write(analisis_tecnico)
    
    # Guardar datos en JSON
    with open(debug_dir / "datos_para_analisis_tecnico.json", "w", encoding="utf-8") as f:
        json.dump({
            "datos_factura": datos_factura,
            "timestamp": datetime.now().isoformat(),
            "tipo_analisis": "tecnico_electrico"
        }, f, ensure_ascii=False, indent=2)


def procesar_factura_con_analisis_tecnico(ruta_csv: str = "outputs/facturas_emcali.csv", 
                                        generar_docx: bool = True, 
                                        hacer_analisis_tecnico: bool = True) -> Dict[str, Any]:
    """
    Procesa una factura con anÃ¡lisis tÃ©cnico de ingeniero elÃ©ctrico.
    
    Args:
        ruta_csv: Ruta al archivo CSV
        generar_docx: Si generar archivo DOCX
        hacer_analisis_tecnico: Si hacer anÃ¡lisis tÃ©cnico elÃ©ctrico
        
    Returns:
        Diccionario con resultados del procesamiento
    """
    try:
        print("ğŸ” Procesando factura con anÃ¡lisis tÃ©cnico elÃ©ctrico...")
        
        # Leer datos del CSV
        print("ğŸ“„ Leyendo datos del CSV...")
        facturas = leer_csv_emcali(ruta_csv)
        
        if not facturas:
            return {"error": "No se encontraron datos en el CSV"}
        
        factura = facturas[0]  # Tomar la primera factura
        resultados = {
            "exito": True,
            "factura_procesada": factura.get('cliente_nombre', 'N/A'),
            "archivos_generados": []
        }
        
        # Generar DOCX
        if generar_docx:
            print("ğŸ“ Generando archivo DOCX...")
            ruta_docx = generar_docx_factura(factura)
            if ruta_docx:
                resultados["archivos_generados"].append(ruta_docx)
        
        # Hacer anÃ¡lisis tÃ©cnico elÃ©ctrico
        if hacer_analisis_tecnico:
            print("âš¡ Generando anÃ¡lisis tÃ©cnico de ingeniero elÃ©ctrico...")
            analisis_resultado = analizar_factura_tecnico_electrico(factura)
            resultados["analisis_tecnico"] = analisis_resultado
            
            if analisis_resultado["exito"]:
                # Guardar anÃ¡lisis tÃ©cnico en archivo separado
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                cliente_nombre = factura.get('cliente_nombre', 'Cliente').replace(' ', '_')
                ruta_analisis_tecnico = f"outputs/informe_tecnico_electrico_{cliente_nombre}_{timestamp}.txt"
                
                with open(ruta_analisis_tecnico, "w", encoding="utf-8") as f:
                    f.write("INFORME TÃ‰CNICO ELÃ‰CTRICO - FACTURA EMCALI\n")
                    f.write("="*60 + "\n\n")
                    f.write("ANÃLISIS REALIZADO POR: Ingeniero ElÃ©ctrico Experto en EnergÃ­a\n")
                    f.write(f"FECHA: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                    f.write(f"CLIENTE: {factura.get('cliente_nombre', 'N/A')}\n")
                    f.write(f"CONTRATO: {factura.get('contrato', 'N/A')}\n")
                    f.write("="*60 + "\n\n")
                    f.write(analisis_resultado["analisis_tecnico"])
                
                resultados["archivos_generados"].append(ruta_analisis_tecnico)
                print(f"âœ… AnÃ¡lisis tÃ©cnico guardado: {ruta_analisis_tecnico}")
        
        print("âœ… Procesamiento con anÃ¡lisis tÃ©cnico finalizado")
        return resultados
        
    except Exception as e:
        return {"error": f"Error en procesamiento con anÃ¡lisis tÃ©cnico: {str(e)}"}


def agregar_analisis_tecnico_a_docx(ruta_docx: str, analisis_tecnico: str) -> str:
    """
    Agrega el anÃ¡lisis tÃ©cnico elÃ©ctrico a un documento DOCX existente.
    
    Args:
        ruta_docx: Ruta al archivo DOCX
        analisis_tecnico: AnÃ¡lisis tÃ©cnico generado por el LLM
        
    Returns:
        Ruta del archivo DOCX actualizado
    """
    try:
        from docx import Document
        from docx.shared import Inches
        from docx.enum.text import WD_ALIGN_PARAGRAPH
        
        # Abrir documento existente
        doc = Document(ruta_docx)
        
        # Agregar pÃ¡gina nueva
        doc.add_page_break()
        
        # TÃ­tulo del anÃ¡lisis tÃ©cnico
        title = doc.add_heading('INFORME TÃ‰CNICO ELÃ‰CTRICO', 0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # SubtÃ­tulo
        subtitle = doc.add_heading('AnÃ¡lisis de Ingeniero ElÃ©ctrico Experto en EnergÃ­a', level=1)
        subtitle.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Agregar anÃ¡lisis tÃ©cnico
        doc.add_paragraph(analisis_tecnico)
        
        # Guardar documento actualizado
        ruta_actualizada = ruta_docx.replace('.docx', '_con_analisis_tecnico.docx')
        doc.save(ruta_actualizada)
        
        print(f"âœ… AnÃ¡lisis tÃ©cnico agregado al DOCX: {ruta_actualizada}")
        return ruta_actualizada
        
    except Exception as e:
        print(f"âŒ Error agregando anÃ¡lisis tÃ©cnico al DOCX: {e}")
        return ruta_docx


def generar_docx_factura_mejorada(canonica: Dict[str, Any], flags: List[str], confidence: float, balance_ok: bool, delta: float, pdf_hash: str) -> str:
    """
    Genera DOCX mejorado con story, reconciliaciÃ³n y metadatos completos.
    
    Args:
        canonica: Datos canÃ³nicos de la factura
        flags: Flags de calidad
        confidence: Score de confianza
        balance_ok: Si el balance estÃ¡ correcto
        delta: Diferencia en el balance
        pdf_hash: Hash del PDF
        
    Returns:
        Ruta del archivo DOCX generado
    """
    try:
        from docx import Document
        from docx.shared import Inches, Pt
        from docx.enum.text import WD_ALIGN_PARAGRAPH
        from docx.enum.style import WD_STYLE_TYPE
        from docx.oxml.shared import OxmlElement, qn
        
        # Crear documento
        doc = Document()
        
        # Configurar estilos
        styles = doc.styles
        style = styles['Normal']
        font = style.font
        font.name = 'Calibri'
        font.size = Pt(11)
        
        # TÃ­tulo principal
        title = doc.add_heading('INFORME DETALLADO DE FACTURA EMCALI', 0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Metadatos del documento
        doc.add_paragraph(f"ğŸ“… Generado el: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        doc.add_paragraph(f"ğŸ” PDF Hash: {pdf_hash}")
        doc.add_paragraph(f"ğŸ“Š Score de Confianza: {confidence:.1%}")
        
        # Alertas si hay flags
        if flags:
            doc.add_heading('âš ï¸ ALERTAS DE CALIDAD', level=1)
            for flag in flags:
                doc.add_paragraph(f"â€¢ {flag}", style='List Bullet')
        
        # 1. RESUMEN EJECUTIVO
        doc.add_heading('1. RESUMEN EJECUTIVO', level=1)
        
        metadatos = canonica.get('metadatos', {})
        doc.add_paragraph(f"ğŸ¢ Contrato: {metadatos.get('contrato', 'N/A')}")
        doc.add_paragraph(f"ğŸ†” NIC: {metadatos.get('nic', 'N/A')}")
        doc.add_paragraph(f"ğŸ” CUDE: {metadatos.get('cude', 'N/A')}")
        doc.add_paragraph(f"ğŸ’³ No. Pago ElectrÃ³nico: {metadatos.get('no_pago_electronico', 'N/A')}")
        doc.add_paragraph(f"ğŸ“… PerÃ­odo: {canonica.get('periodo_inicio', 'N/A')} a {canonica.get('periodo_fin', 'N/A')}")
        doc.add_paragraph(f"ğŸ“† DÃ­as Facturados: {canonica.get('dias_facturados', 'N/A')}")
        doc.add_paragraph(f"ğŸ’° Total a Pagar: ${canonica.get('total_pagar_cop', 0):,.2f} COP")
        
        # 2. ANÃLISIS DE ENERGÃA ELÃ‰CTRICA
        doc.add_heading('2. ANÃLISIS DE ENERGÃA ELÃ‰CTRICA', level=1)
        
        energia = canonica.get('energia', {})
        if energia:
            doc.add_paragraph(f"ğŸ“Š Lectura Inicial: {energia.get('lectura_inicial', 'N/A'):,.0f} kWh")
            doc.add_paragraph(f"ğŸ“Š Lectura Final: {energia.get('lectura_final', 'N/A'):,.0f} kWh")
            doc.add_paragraph(f"âš¡ Consumo del PerÃ­odo: {energia.get('consumo_kwh', 'N/A'):,.0f} kWh")
            doc.add_paragraph(f"ğŸ’µ Tarifa Unitaria: ${energia.get('cuv_cop_kwh', 0):,.2f} COP/kWh")
            
            # Consumo diario promedio
            dias = canonica.get('dias_facturados', 30)
            consumo_diario = energia.get('consumo_kwh', 0) / dias if dias > 0 else 0
            doc.add_paragraph(f"ğŸ“ˆ Consumo Diario Promedio: {consumo_diario:.1f} kWh/dÃ­a")
            
            # Base vs Total
            base_cop = energia.get('base_cop', 0)
            total_cop = energia.get('total_cop', 0)
            doc.add_paragraph(f"ğŸ’µ Base: ${base_cop:,.2f} COP")
            doc.add_paragraph(f"ğŸ’µ Total: ${total_cop:,.2f} COP")
            
            if base_cop and total_cop and base_cop != total_cop:
                diferencia = total_cop - base_cop
                doc.add_paragraph(f"ğŸ“Š Diferencia (Total - Base): ${diferencia:,.2f} COP", style='Intense Quote')
        
        # 3. SERVICIOS DE ACUEDUCTO Y ALCANTARILLADO
        doc.add_heading('3. SERVICIOS DE ACUEDUCTO Y ALCANTARILLADO', level=1)
        
        # Acueducto
        acueducto = canonica.get('acueducto', {})
        if acueducto:
            doc.add_heading('ğŸ’§ Acueducto', level=2)
            doc.add_paragraph(f"ğŸ“Š Consumo: {acueducto.get('consumo_m3', 'N/A'):,.0f} mÂ³")
            doc.add_paragraph(f"ğŸ’µ Tarifa: ${acueducto.get('tarifa_cop_m3', 0):,.2f} COP/mÂ³")
            doc.add_paragraph(f"ğŸ’° Total: ${acueducto.get('total_cop', 0):,.2f} COP")
            
            # Consumo diario promedio
            consumo_diario_agua = acueducto.get('consumo_m3', 0) / dias if dias > 0 else 0
            doc.add_paragraph(f"ğŸ“ˆ Consumo Diario Promedio: {consumo_diario_agua:.1f} mÂ³/dÃ­a")
        
        # Alcantarillado
        alcantarillado = canonica.get('alcantarillado', {})
        if alcantarillado:
            doc.add_heading('ğŸš° Alcantarillado', level=2)
            doc.add_paragraph(f"ğŸ“Š Consumo: {alcantarillado.get('consumo_m3', 'N/A'):,.0f} mÂ³")
            doc.add_paragraph(f"ğŸ’µ Tarifa: ${alcantarillado.get('tarifa_cop_m3', 0):,.2f} COP/mÂ³")
            doc.add_paragraph(f"ğŸ’° Total: ${alcantarillado.get('total_cop', 0):,.2f} COP")
        
        # 4. SERVICIOS COMPLEMENTARIOS
        doc.add_heading('4. SERVICIOS COMPLEMENTARIOS', level=1)
        
        # Aseo
        aseo = canonica.get('aseo', {})
        if aseo:
            doc.add_paragraph(f"ğŸ—‘ï¸ Aseo: ${aseo.get('total_cop', 0):,.2f} COP")
        
        # Alumbrado PÃºblico
        alumbrado = canonica.get('alumbrado_publico', {})
        if alumbrado:
            doc.add_paragraph(f"ğŸ’¡ Alumbrado PÃºblico: ${alumbrado.get('total_cop', 0):,.2f} COP")
        
        # Tasa de Seguridad
        tasa_seguridad = canonica.get('tasa_seguridad', {})
        if tasa_seguridad:
            doc.add_paragraph(f"ğŸ›¡ï¸ Tasa de Seguridad: ${tasa_seguridad.get('total_cop', 0):,.2f} COP")
        
        # 5. IMPUESTOS Y TOTALES
        doc.add_heading('5. IMPUESTOS Y TOTALES', level=1)
        
        iva = canonica.get('iva_total_cop', 0)
        doc.add_paragraph(f"ğŸ›ï¸ IVA: ${iva:,.2f} COP")
        
        total_pagar = canonica.get('total_pagar_cop', 0)
        doc.add_paragraph(f"ğŸ’° Total a Pagar: ${total_pagar:,.2f} COP", style='Intense Quote')
        
        # 6. ANÃLISIS COMPARATIVO
        doc.add_heading('6. ANÃLISIS COMPARATIVO', level=1)
        
        # ComparaciÃ³n con Ãºltimo pago
        ultimo_pago = metadatos.get('ultimo_pago_valor', 0)
        if ultimo_pago and ultimo_pago > 0:
            diferencia_pago = total_pagar - ultimo_pago
            porcentaje_cambio = (diferencia_pago / ultimo_pago) * 100 if ultimo_pago > 0 else 0
            
            doc.add_paragraph(f"ğŸ“Š Ãšltimo Pago: ${ultimo_pago:,.2f} COP")
            doc.add_paragraph(f"ğŸ“Š Pago Actual: ${total_pagar:,.2f} COP")
            doc.add_paragraph(f"ğŸ“ˆ Diferencia: ${diferencia_pago:,.2f} COP")
            doc.add_paragraph(f"ğŸ“Š Cambio Porcentual: {porcentaje_cambio:+.1f}%")
            
            if porcentaje_cambio > 10:
                doc.add_paragraph("âš ï¸ INCREMENTO SIGNIFICATIVO DETECTADO", style='Intense Quote')
            elif porcentaje_cambio < -10:
                doc.add_paragraph("âœ… REDUCCIÃ“N SIGNIFICATIVA DETECTADA", style='Intense Quote')
        
        # 7. RECONCILIACIÃ“N DE TOTALES
        doc.add_heading('7. RECONCILIACIÃ“N DE TOTALES', level=1)
        
        # Calcular suma de componentes
        suma_componentes = 0.0
        
        if energia:
            suma_componentes += energia.get('total_cop', 0)
        if acueducto:
            suma_componentes += acueducto.get('total_cop', 0)
        if alcantarillado:
            suma_componentes += alcantarillado.get('total_cop', 0)
        if aseo:
            suma_componentes += aseo.get('total_cop', 0)
        if alumbrado:
            suma_componentes += alumbrado.get('total_cop', 0)
        if tasa_seguridad:
            suma_componentes += tasa_seguridad.get('total_cop', 0)
        
        # Otros servicios
        otros = canonica.get('otros', {})
        if otros:
            suma_componentes += otros.get('total_cop', 0)
        
        # IVA
        suma_componentes += iva
        
        doc.add_paragraph(f"ğŸ“Š Suma de Componentes: ${suma_componentes:,.2f} COP")
        doc.add_paragraph(f"ğŸ“Š Total Declarado: ${total_pagar:,.2f} COP")
        doc.add_paragraph(f"ğŸ“Š Diferencia: ${delta:,.2f} COP")
        
        # SemÃ¡foro de reconciliaciÃ³n
        if balance_ok:
            doc.add_paragraph("âœ… RECONCILIACIÃ“N: CORRECTA", style='Intense Quote')
        else:
            doc.add_paragraph("âš ï¸ RECONCILIACIÃ“N: REQUIERE REVISIÃ“N", style='Intense Quote')
        
        # 8. RECOMENDACIONES
        doc.add_heading('8. RECOMENDACIONES', level=1)
        
        # Recomendaciones basadas en el consumo
        if energia:
            consumo_kwh = energia.get('consumo_kwh', 0)
            if consumo_kwh > 1000:
                doc.add_paragraph("ğŸ’¡ Consumo de energÃ­a alto. Considere implementar medidas de eficiencia energÃ©tica.", style='List Bullet')
            elif consumo_kwh < 300:
                doc.add_paragraph("âœ… Consumo de energÃ­a bajo. Buen trabajo en eficiencia energÃ©tica.", style='List Bullet')
        
        if acueducto:
            consumo_agua = acueducto.get('consumo_m3', 0)
            if consumo_agua > 50:
                doc.add_paragraph("ğŸ’§ Consumo de agua alto. Revise posibles fugas o implemente medidas de ahorro.", style='List Bullet')
        
        doc.add_paragraph("ğŸ“Š Monitoree regularmente su consumo para identificar tendencias.", style='List Bullet')
        doc.add_paragraph("ğŸ’° Compare con perÃ­odos anteriores para detectar anomalÃ­as.", style='List Bullet')
        
        # 9. ANÃLISIS TÃ‰CNICO PROFESIONAL
        doc.add_heading('9. ANÃLISIS TÃ‰CNICO PROFESIONAL', level=1)
        doc.add_paragraph("ğŸ”¬ AnÃ¡lisis realizado por: Ingeniero ElÃ©ctrico Especialista en EnergÃ­a Eficiente")
        
        # CaracterizaciÃ³n tÃ©cnica del consumo
        if energia:
            consumo_kwh = energia.get('consumo_kwh', 0)
            dias = canonica.get('dias_facturados', 30)
            consumo_diario = consumo_kwh / dias if dias > 0 else 0
            potencia_promedio = consumo_diario / 24  # kW promedio
            
            doc.add_heading('CaracterizaciÃ³n TÃ©cnica del Consumo', level=2)
            doc.add_paragraph(f"âš¡ Potencia Promedio: {potencia_promedio:.2f} kW")
            doc.add_paragraph(f"ğŸ“Š Consumo Diario: {consumo_diario:.1f} kWh/dÃ­a")
            doc.add_paragraph(f"ğŸ“ˆ Factor de Carga Estimado: {potencia_promedio/10:.2f} (normal: 0.2-0.4)")
            
            # DiagnÃ³stico tÃ©cnico
            doc.add_heading('DiagnÃ³stico TÃ©cnico', level=2)
            
            if consumo_diario > 200:
                doc.add_paragraph("ğŸ”´ CONSUMO CRÃTICAMENTE ALTO", style='Intense Quote')
                doc.add_paragraph("â€¢ Equivalente a 10+ aires acondicionados de 1 tonelada", style='List Bullet')
                doc.add_paragraph("â€¢ Requiere auditorÃ­a energÃ©tica inmediata", style='List Bullet')
                doc.add_paragraph("â€¢ Potencial de ahorro: 40-60% del consumo", style='List Bullet')
            elif consumo_diario > 100:
                doc.add_paragraph("âš ï¸ CONSUMO ELEVADO", style='Intense Quote')
                doc.add_paragraph("â€¢ Consumo superior al promedio residencial", style='List Bullet')
                doc.add_paragraph("â€¢ Oportunidad de optimizaciÃ³n significativa", style='List Bullet')
                doc.add_paragraph("â€¢ Potencial de ahorro: 20-40% del consumo", style='List Bullet')
            elif consumo_diario > 50:
                doc.add_paragraph("ğŸŸ¡ CONSUMO MODERADO", style='Intense Quote')
                doc.add_paragraph("â€¢ Consumo dentro de rangos aceptables", style='List Bullet')
                doc.add_paragraph("â€¢ OptimizaciÃ³n recomendada", style='List Bullet')
                doc.add_paragraph("â€¢ Potencial de ahorro: 10-20% del consumo", style='List Bullet')
            else:
                doc.add_paragraph("âœ… CONSUMO EFICIENTE", style='Intense Quote')
                doc.add_paragraph("â€¢ Excelente gestiÃ³n energÃ©tica", style='List Bullet')
                doc.add_paragraph("â€¢ Mantener buenas prÃ¡cticas", style='List Bullet')
                doc.add_paragraph("â€¢ Potencial de ahorro: 5-10% del consumo", style='List Bullet')
        
        # AnÃ¡lisis econÃ³mico tÃ©cnico
        doc.add_heading('AnÃ¡lisis EconÃ³mico TÃ©cnico', level=2)
        
        if energia:
            tarifa_kwh = energia.get('cuv_cop_kwh', 0)
            costo_energia = energia.get('total_cop', 0)
            total_factura = canonica.get('total_pagar_cop', 0)
            porcentaje_energia = (costo_energia / total_factura * 100) if total_factura > 0 else 0
            
            doc.add_paragraph(f"ğŸ’µ Tarifa Unitaria: ${tarifa_kwh:,.2f} COP/kWh")
            doc.add_paragraph(f"ğŸ’° Costo Total EnergÃ­a: ${costo_energia:,.2f} COP")
            doc.add_paragraph(f"ğŸ“Š Porcentaje EnergÃ­a: {porcentaje_energia:.1f}% del total")
            
            if porcentaje_energia > 80:
                doc.add_paragraph("ğŸ”´ ALTA DEPENDENCIA ENERGÃ‰TICA", style='Intense Quote')
                doc.add_paragraph("â€¢ La energÃ­a representa mÃ¡s del 80% del costo total", style='List Bullet')
                doc.add_paragraph("â€¢ Vulnerable a incrementos tarifarios", style='List Bullet')
                doc.add_paragraph("â€¢ Urgente implementar medidas de eficiencia", style='List Bullet')
            elif porcentaje_energia > 60:
                doc.add_paragraph("âš ï¸ DEPENDENCIA ENERGÃ‰TICA MODERADA", style='Intense Quote')
                doc.add_paragraph("â€¢ La energÃ­a representa mÃ¡s del 60% del costo total", style='List Bullet')
                doc.add_paragraph("â€¢ Recomendable optimizar consumo", style='List Bullet')
            else:
                doc.add_paragraph("âœ… DISTRIBUCIÃ“N EQUILIBRADA", style='Intense Quote')
                doc.add_paragraph("â€¢ Buena distribuciÃ³n de costos entre servicios", style='List Bullet')
        
        # Recomendaciones tÃ©cnicas especÃ­ficas
        doc.add_heading('Recomendaciones TÃ©cnicas EspecÃ­ficas', level=2)
        
        if energia:
            consumo_kwh = energia.get('consumo_kwh', 0)
            
            if consumo_kwh > 5000:
                doc.add_paragraph("ğŸ”´ MEDIDAS URGENTES (Alto Consumo):", style='Intense Quote')
                doc.add_paragraph("â€¢ AuditorÃ­a energÃ©tica profesional", style='List Bullet')
                doc.add_paragraph("â€¢ Sistema de gestiÃ³n energÃ©tica (EMS)", style='List Bullet')
                doc.add_paragraph("â€¢ AnÃ¡lisis de curvas de carga", style='List Bullet')
                doc.add_paragraph("â€¢ OptimizaciÃ³n de sistemas HVAC", style='List Bullet')
                doc.add_paragraph("â€¢ Sistema solar fotovoltaico 20-50 kWp", style='List Bullet')
                
            elif consumo_kwh > 2000:
                doc.add_paragraph("âš ï¸ MEDIDAS RECOMENDADAS (Consumo Elevado):", style='Intense Quote')
                doc.add_paragraph("â€¢ IluminaciÃ³n LED completa", style='List Bullet')
                doc.add_paragraph("â€¢ Termostatos inteligentes", style='List Bullet')
                doc.add_paragraph("â€¢ ElectrodomÃ©sticos eficientes A+++", style='List Bullet')
                doc.add_paragraph("â€¢ Sistema solar fotovoltaico 5-10 kWp", style='List Bullet')
                doc.add_paragraph("â€¢ Aislamiento tÃ©rmico", style='List Bullet')
                
            else:
                doc.add_paragraph("âœ… MEDIDAS DE OPTIMIZACIÃ“N (Consumo Moderado):", style='Intense Quote')
                doc.add_paragraph("â€¢ Reemplazo de luminarias por LED", style='List Bullet')
                doc.add_paragraph("â€¢ ProgramaciÃ³n de equipos", style='List Bullet')
                doc.add_paragraph("â€¢ Mantenimiento preventivo", style='List Bullet')
                doc.add_paragraph("â€¢ Sistema solar fotovoltaico 3-5 kWp", style='List Bullet')
        
        # Proyecciones financieras
        doc.add_heading('Proyecciones Financieras', level=2)
        
        if energia:
            consumo_kwh = energia.get('consumo_kwh', 0)
            costo_energia = energia.get('total_cop', 0)
            
            if consumo_kwh > 5000:
                ahorro_estimado = costo_energia * 0.5  # 50% de ahorro
                doc.add_paragraph(f"ğŸ’° Ahorro Potencial Anual: ${ahorro_estimado * 12:,.0f} COP", style='Intense Quote')
                doc.add_paragraph("â€¢ ROI estimado: 3-4 aÃ±os", style='List Bullet')
                doc.add_paragraph("â€¢ InversiÃ³n requerida: $80-200 millones COP", style='List Bullet')
                
            elif consumo_kwh > 2000:
                ahorro_estimado = costo_energia * 0.3  # 30% de ahorro
                doc.add_paragraph(f"ğŸ’° Ahorro Potencial Anual: ${ahorro_estimado * 12:,.0f} COP", style='Intense Quote')
                doc.add_paragraph("â€¢ ROI estimado: 2-3 aÃ±os", style='List Bullet')
                doc.add_paragraph("â€¢ InversiÃ³n requerida: $20-50 millones COP", style='List Bullet')
                
            else:
                ahorro_estimado = costo_energia * 0.15  # 15% de ahorro
                doc.add_paragraph(f"ğŸ’° Ahorro Potencial Anual: ${ahorro_estimado * 12:,.0f} COP", style='Intense Quote')
                doc.add_paragraph("â€¢ ROI estimado: 1-2 aÃ±os", style='List Bullet')
                doc.add_paragraph("â€¢ InversiÃ³n requerida: $5-15 millones COP", style='List Bullet')
        
        # 10. METADATOS TÃ‰CNICOS
        doc.add_heading('10. METADATOS TÃ‰CNICOS', level=1)
        
        doc.add_paragraph(f"ğŸ” PDF Hash: {pdf_hash}")
        doc.add_paragraph(f"ğŸ“… Procesado: {metadatos.get('processed_at', 'N/A')}")
        doc.add_paragraph(f"ğŸ“‹ Schema Version: {metadatos.get('schema_version', 'N/A')}")
        doc.add_paragraph(f"ğŸ¤– Prompt Version: {metadatos.get('prompt_version', 'N/A')}")
        doc.add_paragraph(f"ğŸ“Š Confidence Score: {confidence:.1%}")
        doc.add_paragraph(f"ğŸ“… Ãšltimo Pago: {metadatos.get('ultimo_pago_fecha', 'N/A')}")
        doc.add_paragraph(f"ğŸ’° Valor Ãšltimo Pago: ${metadatos.get('ultimo_pago_valor', 0):,.2f} COP")
        
        # 10. OTROS CONCEPTOS
        if otros and otros.get('items'):
            doc.add_heading('10. OTROS CONCEPTOS', level=1)
            for item in otros['items']:
                doc.add_paragraph(f"â€¢ {item.get('label', 'N/A')}: ${item.get('total_cop', 0):,.2f} COP", style='List Bullet')
        
        # Guardar documento
        nombre_cliente = metadatos.get('contrato', 'Cliente')
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        nombre_archivo = f"informe_factura_{nombre_cliente}_{timestamp}.docx"
        ruta_archivo = Path("outputs") / nombre_archivo
        
        doc.save(str(ruta_archivo))
        print(f"âœ… DOCX mejorado generado: {ruta_archivo}")
        
        return str(ruta_archivo)
        
    except Exception as e:
        print(f"âŒ Error generando DOCX mejorado: {e}")
        return ""
